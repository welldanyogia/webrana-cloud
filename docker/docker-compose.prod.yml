# WeBrana Cloud - Production Docker Compose Overrides
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Resource limits optimized for 4GB RAM server:
# - Backend services: 256MB each (7 services × 256MB = 1.75GB)
# - Frontend services: 384MB each (2 services × 384MB = 768MB)
# - PostgreSQL: 512MB
# - Redis: 128MB
# - Nginx: 64MB
# - Total: ~3.2GB (leaving ~800MB for OS and overhead)

version: '3.8'

services:
  # ═══════════════════════════════════════════════════════════════════════════
  # DATABASE & CACHE - Production Overrides
  # ═══════════════════════════════════════════════════════════════════════════

  postgres:
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  redis:
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

  # ═══════════════════════════════════════════════════════════════════════════
  # BACKEND SERVICES - Production Overrides
  # ═══════════════════════════════════════════════════════════════════════════

  api-gateway:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "5"

  auth-service:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "5"

  catalog-service:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "5"

  order-service:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "5"

  billing-service:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "5"

  instance-service:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "5"

  notification-service:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "5"

  # ═══════════════════════════════════════════════════════════════════════════
  # FRONTEND SERVICES - Production Overrides
  # ═══════════════════════════════════════════════════════════════════════════

  customer-web:
    deploy:
      resources:
        limits:
          memory: 384M
        reservations:
          memory: 192M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "5"

  admin-web:
    deploy:
      resources:
        limits:
          memory: 384M
        reservations:
          memory: 192M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "5"

  # ═══════════════════════════════════════════════════════════════════════════
  # REVERSE PROXY - Production Overrides
  # ═══════════════════════════════════════════════════════════════════════════

  nginx:
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
