// Prisma schema for Catalog Service
// Database: PostgreSQL
// Schema: catalog

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// ENUMS
// ===========================================

enum PlanDuration {
  MONTHLY
  YEARLY
}

enum DiscountType {
  PERCENT
  FIXED
}

enum ImageCategory {
  OS
  APP
}

// ===========================================
// MODELS
// ===========================================

model VpsPlan {
  id              String    @id @default(uuid()) @db.Uuid
  name            String    @db.VarChar(255)
  displayName     String    @map("display_name") @db.VarChar(255)
  description     String?   @db.Text
  cpu             Int
  memoryMb        Int       @map("memory_mb")
  diskGb          Int       @map("disk_gb")
  bandwidthTb     Float     @map("bandwidth_tb")
  provider        String    @db.VarChar(50)
  providerSizeSlug String   @map("provider_size_slug") @db.VarChar(100)
  isActive        Boolean   @default(true) @map("is_active")
  sortOrder       Int       @default(0) @map("sort_order")
  tags            String[]  @default([])
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  pricings        PlanPricing[]
  promos          PlanPromo[]
  allowedImages   VpsPlanImage[]
  couponPlans     CouponPlan[]

  @@index([isActive])
  @@index([sortOrder])
  @@index([provider])
  @@map("vps_plans")
}

model PlanPricing {
  id        String       @id @default(uuid()) @db.Uuid
  planId    String       @map("plan_id") @db.Uuid
  duration  PlanDuration
  price     Float
  cost      Float
  isActive  Boolean      @default(true) @map("is_active")
  createdAt DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  plan VpsPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, duration])
  @@index([planId])
  @@index([isActive])
  @@map("plan_pricings")
}

model PlanPromo {
  id            String       @id @default(uuid()) @db.Uuid
  planId        String       @map("plan_id") @db.Uuid
  name          String       @db.VarChar(255)
  discountType  DiscountType @map("discount_type")
  discountValue Float        @map("discount_value")
  startDate     DateTime     @map("start_date") @db.Timestamptz
  endDate       DateTime     @map("end_date") @db.Timestamptz
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  plan VpsPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([isActive])
  @@index([startDate, endDate])
  @@map("plan_promos")
}

model VpsImage {
  id           String        @id @default(uuid()) @db.Uuid
  provider     String        @db.VarChar(50)
  providerSlug String        @map("provider_slug") @db.VarChar(100)
  displayName  String        @map("display_name") @db.VarChar(255)
  description  String?       @db.Text
  category     ImageCategory @default(OS)
  version      String?       @db.VarChar(50)
  isActive     Boolean       @default(true) @map("is_active")
  sortOrder    Int           @default(0) @map("sort_order")
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  planImages VpsPlanImage[]

  @@unique([provider, providerSlug])
  @@index([isActive])
  @@index([category])
  @@map("vps_images")
}

model VpsPlanImage {
  id        String   @id @default(uuid()) @db.Uuid
  planId    String   @map("plan_id") @db.Uuid
  imageId   String   @map("image_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  plan  VpsPlan  @relation(fields: [planId], references: [id], onDelete: Cascade)
  image VpsImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@unique([planId, imageId])
  @@index([planId])
  @@index([imageId])
  @@map("vps_plan_images")
}

model Coupon {
  id                    String       @id @default(uuid()) @db.Uuid
  code                  String       @unique @db.VarChar(50)
  name                  String       @db.VarChar(255)
  description           String?      @db.Text
  discountType          DiscountType @map("discount_type")
  discountValue         Float        @map("discount_value")
  minOrderAmount        Float?       @map("min_order_amount")
  maxDiscountAmount     Float?       @map("max_discount_amount")
  maxTotalRedemptions   Int?         @map("max_total_redemptions")
  maxRedemptionsPerUser Int?         @map("max_redemptions_per_user") @default(1)
  startAt               DateTime     @map("start_at") @db.Timestamptz
  endAt                 DateTime     @map("end_at") @db.Timestamptz
  isActive              Boolean      @default(true) @map("is_active")
  createdAt             DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  couponPlans     CouponPlan[]
  couponUsers     CouponUser[]
  redemptions     CouponRedemption[]

  @@index([code])
  @@index([isActive])
  @@index([startAt, endAt])
  @@map("coupons")
}

model CouponPlan {
  id        String   @id @default(uuid()) @db.Uuid
  couponId  String   @map("coupon_id") @db.Uuid
  planId    String   @map("plan_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  coupon Coupon  @relation(fields: [couponId], references: [id], onDelete: Cascade)
  plan   VpsPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([couponId, planId])
  @@index([couponId])
  @@index([planId])
  @@map("coupon_plans")
}

model CouponUser {
  id        String   @id @default(uuid()) @db.Uuid
  couponId  String   @map("coupon_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@unique([couponId, userId])
  @@index([couponId])
  @@index([userId])
  @@map("coupon_users")
}

model CouponRedemption {
  id         String   @id @default(uuid()) @db.Uuid
  couponId   String   @map("coupon_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  orderId    String?  @map("order_id") @db.Uuid
  amount     Float
  redeemedAt DateTime @default(now()) @map("redeemed_at") @db.Timestamptz

  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([userId])
  @@index([orderId])
  @@map("coupon_redemptions")
}
