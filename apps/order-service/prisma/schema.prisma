// Prisma schema for Order Service
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// ENUMS
// ===========================================

enum OrderStatus {
  // New balance-based flow statuses
  PENDING           // Order created, awaiting balance deduction
  PROCESSING        // Balance deducted, provisioning starting
  PROVISIONING      // Creating VPS on DO
  ACTIVE            // VPS running normally
  EXPIRING_SOON     // < threshold before expiration
  EXPIRED           // Past expiration date (grace period)
  SUSPENDED         // VPS powered off (monthly/yearly grace)
  TERMINATED        // VPS destroyed
  FAILED            // Provisioning failed
  CANCELED          // User canceled before provisioning
  
  // Legacy statuses for backward compatibility
  PENDING_PAYMENT   // @deprecated - use PENDING
  PAID              // @deprecated - use PROCESSING
}

enum PlanDuration {
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
}

enum ItemType {
  PLAN
  IMAGE
  ADDON
}

enum ProvisioningStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
}

enum BillingPeriod {
  DAILY
  MONTHLY
  YEARLY
}

enum TerminationReason {
  USER_DELETED
  EXPIRED_NO_RENEWAL
  INSUFFICIENT_BALANCE
  ADMIN_TERMINATED
  DO_ACCOUNT_ISSUE
  POLICY_VIOLATION
}

enum RenewalType {
  AUTO_RENEWAL
  MANUAL_RENEWAL
  ADMIN_EXTENSION
  REPLACEMENT_VPS
}

enum AccountHealth {
  HEALTHY
  DEGRADED
  UNHEALTHY
  UNKNOWN
}

// ===========================================
// MODELS
// ===========================================

model DoAccount {
  id              String        @id @default(uuid()) @db.Uuid
  
  // Account Info
  name            String        @db.VarChar(100)
  email           String        @db.VarChar(255)
  accessToken     String        @map("access_token") @db.Text  // encrypted
  
  // Limits (cached from DO API)
  dropletLimit    Int           @default(25) @map("droplet_limit")
  activeDroplets  Int           @default(0) @map("active_droplets")
  
  // Status
  isActive        Boolean       @default(true) @map("is_active")
  isPrimary       Boolean       @default(false) @map("is_primary")
  
  // Health
  lastHealthCheck DateTime?     @map("last_health_check") @db.Timestamptz
  healthStatus    AccountHealth @default(UNKNOWN) @map("health_status")
  
  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz
  
  // Relations
  provisioningTasks ProvisioningTask[]
  
  @@index([isActive, healthStatus])
  @@map("do_accounts")
}

model Order {
  id                String        @id @default(uuid()) @db.Uuid
  userId            String        @map("user_id")

  // Plan & Image Reference (snapshot from catalog-service)
  // Note: Cross-service IDs don't use @db.Uuid to allow flexible ID formats
  planId            String        @map("plan_id")
  planName          String        @map("plan_name") @db.VarChar(255)
  imageId           String        @map("image_id")
  imageName         String        @map("image_name") @db.VarChar(255)
  duration          PlanDuration  // Legacy field for backward compatibility

  // Billing Period (new balance-based system)
  billingPeriod     BillingPeriod @default(MONTHLY) @map("billing_period")

  // Pricing Snapshot (all prices in smallest unit, e.g., cents or IDR)
  basePrice         Int           @map("base_price")
  promoDiscount     Int           @default(0) @map("promo_discount")
  couponCode        String?       @map("coupon_code") @db.VarChar(50)
  couponDiscount    Int           @default(0) @map("coupon_discount")
  finalPrice        Int           @map("final_price")
  currency          String        @default("IDR") @db.VarChar(3)

  // Status & Versioning (optimistic locking for race-condition safety)
  status            OrderStatus   @default(PENDING_PAYMENT)
  version           Int           @default(0)

  // Lifecycle Dates
  activatedAt       DateTime?     @map("activated_at") @db.Timestamptz
  expiresAt         DateTime?     @map("expires_at") @db.Timestamptz
  suspendedAt       DateTime?     @map("suspended_at") @db.Timestamptz
  terminatedAt      DateTime?     @map("terminated_at") @db.Timestamptz

  // Auto-renewal configuration
  autoRenew         Boolean       @default(true) @map("auto_renew")
  lastRenewalAt     DateTime?     @map("last_renewal_at") @db.Timestamptz
  renewalFailReason String?       @map("renewal_fail_reason") @db.VarChar(255)

  // Termination tracking
  terminationReason TerminationReason? @map("termination_reason")

  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime      @updatedAt @map("updated_at") @db.Timestamptz
  paidAt            DateTime?     @map("paid_at") @db.Timestamptz

  // Relations
  items             OrderItem[]
  provisioningTask  ProvisioningTask?
  statusHistory     StatusHistory[]
  renewalHistory    RenewalHistory[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([userId, status])
  @@index([status, expiresAt])
  @@index([status, autoRenew, expiresAt])
  @@map("orders")
}

model OrderItem {
  id            String    @id @default(uuid()) @db.Uuid
  orderId       String    @map("order_id") @db.Uuid
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  itemType      ItemType  @map("item_type")
  referenceId   String    @map("reference_id")
  description   String    @db.VarChar(500)
  unitPrice     Int       @map("unit_price")
  quantity      Int       @default(1)
  totalPrice    Int       @map("total_price")

  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@index([orderId])
  @@map("order_items")
}

model ProvisioningTask {
  id              String              @id @default(uuid()) @db.Uuid
  orderId         String              @unique @map("order_id") @db.Uuid
  order           Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // DO Account used for provisioning (multi-account support)
  doAccountId     String?             @map("do_account_id") @db.Uuid
  doAccount       DoAccount?          @relation(fields: [doAccountId], references: [id])

  status          ProvisioningStatus  @default(PENDING)

  // DigitalOcean Request Config
  doRegion        String?             @map("do_region") @db.VarChar(50)
  doSize          String?             @map("do_size") @db.VarChar(100)
  doImage         String?             @map("do_image") @db.VarChar(100)

  // DigitalOcean Response (Full Metadata)
  dropletId       String?             @map("droplet_id") @db.VarChar(50)
  dropletName     String?             @map("droplet_name") @db.VarChar(255)
  ipv4Public      String?             @map("ipv4_public") @db.VarChar(45)
  ipv4Private     String?             @map("ipv4_private") @db.VarChar(45)
  dropletStatus   String?             @map("droplet_status") @db.VarChar(50)
  dropletTags     String[]            @default([]) @map("droplet_tags")
  dropletCreatedAt DateTime?          @map("droplet_created_at") @db.Timestamptz

  // Error Tracking
  errorCode       String?             @map("error_code") @db.VarChar(100)
  errorMessage    String?             @map("error_message") @db.Text
  attempts        Int                 @default(0)

  // Timestamps
  startedAt       DateTime?           @map("started_at") @db.Timestamptz
  completedAt     DateTime?           @map("completed_at") @db.Timestamptz
  createdAt       DateTime            @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime            @updatedAt @map("updated_at") @db.Timestamptz

  @@index([status])
  @@index([dropletId])
  @@map("provisioning_tasks")
}

model StatusHistory {
  id              String    @id @default(uuid()) @db.Uuid
  orderId         String    @map("order_id") @db.Uuid
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  previousStatus  String    @map("previous_status") @db.VarChar(50)
  newStatus       String    @map("new_status") @db.VarChar(50)
  actor           String    @db.VarChar(255)
  reason          String?   @db.Text
  metadata        Json?

  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@index([orderId])
  @@index([createdAt])
  @@map("status_history")
}

model RenewalHistory {
  id              String        @id @default(uuid()) @db.Uuid
  orderId         String        @map("order_id") @db.Uuid
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  renewalType     RenewalType   @map("renewal_type")
  amount          Int           // Amount charged for renewal

  previousExpiry  DateTime      @map("previous_expiry") @db.Timestamptz
  newExpiry       DateTime      @map("new_expiry") @db.Timestamptz

  // For failed renewals
  success         Boolean       @default(true)
  failReason      String?       @map("fail_reason") @db.VarChar(255)

  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz

  @@index([orderId])
  @@index([createdAt])
  @@map("renewal_history")
}

model CronJobLock {
  id          String   @id @default(uuid()) @db.Uuid
  jobName     String   @unique @map("job_name")
  lockedAt    DateTime @map("locked_at") @db.Timestamptz
  lockedBy    String   @map("locked_by") @db.VarChar(100)
  expiresAt   DateTime @map("expires_at") @db.Timestamptz

  @@map("cron_job_locks")
}
